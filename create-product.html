<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <!-- Bootstrap CSS -->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

        <title>Premium Fashion</title>


        <!-- MQTT - Gateway Script -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js" integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script>
            //======================================================================
            // IOTA Tangle Configuration
            //======================================================================
            // This example using raspberry pi gateway to filter the message
            // read more: https://github.com/SuryaAssistant/iota-raspberrypi-gateway

            var companyPublicKey = "02fc8d163ee74b6e972bcc94481d0006f13c8e20896087fbfbda3ebc326ce2269b";
            var gatewayId = "0xb827eba5f9f6";

            //======================================================================
            // Product Information
            //======================================================================
            var productID, productName, productDescription;
            var productHash;
            var productJSON;

            var tagIndex, tagIndexHash;

            //======================================================================
            // MQTT Configuration
            //======================================================================
            var mqtt;
            var reconnectTimeout = 2000;
            var host = "test.mosquitto.org";
            var port = 8080;

            // create random mqtt topic
            let returnTopic = Math.random() * 10000000;
            returnTopic = Math.floor(returnTopic);

            var subscribeTopic = gatewayId + '/' + returnTopic;
            console.log("MQTT Topic : " + subscribeTopic);

            //======================================================================
            // Function to get data from form
            //======================================================================
            function create(){
                // Get product information
                productName = document.getElementById("inputName").value;
                productID = document.getElementById("inputID").value;
                productDescription = document.getElementById("inputDescription").value;

                // Create special JSON format
                productJSON = "{'name':'"+productName+"','id':'"+productID+"','desc':'"+productDescription+"'}"
                console.log(productJSON);
                
                // Get Keccak-256 hash of product ID
                productHash = CryptoJS.SHA3(productID, { outputLength: 256 }).toString(CryptoJS.enc.Hex);
                console.log("Hash : " + productHash);

                // Create tag index for company
                tagIndex = companyPublicKey + 'premium' + productHash;

                // Hash tag Index to shrink the size
                tagIndexHash = CryptoJS.SHA3(tagIndex, { outputLength: 256 }).toString(CryptoJS.enc.Hex);
                console.log("Tag Index Hash : " + tagIndexHash);

                // Prepare MQTT connection to gateway
                MQTTconnect();
            }

            //======================================================================
            // MQTT Function
            //======================================================================
            // When user is connect to mqtt, subscribe randomized topic and send 
            function onConnect(){
                // Subscribe topic
                mqtt.subscribe(subscribeTopic);

                // Send submit request to gateway
                // format : submit_special/tag_index/data/return_topic
                mqtt_msg = "data_special/" + tagIndexHash + '/' + productJSON + '/'+ returnTopic;
                
                product_msg = new Paho.MQTT.Message(mqtt_msg);
                product_msg.destinationName = gatewayId + "/submit" ;
                mqtt.send(product_msg);

                // change display
                document.getElementById("blockchain_data").innerHTML=`
                    <div class="row">
                        <p>Create a request connection to gateway . . .</p>
                        <p>Please wait. It may take 1-2 minute</p>
                    </div>
                `;
            }

            function onFailure(){
                console.log("Failed to connect");
                setTimeout(MQTTconnect, reconnectTimeout);
            }

            // If gateway give response, display it
            function onMessageArrived(msg){
                IOTAResponse=msg.payloadString;

                // show the data in html
                document.getElementById("blockchain_data").innerHTML = `
                    <div class="row">
                        <p>Product submitted succesfully at address ${IOTAResponse}</p>
                    </div>
                `;
            }

            // Function to start a connection to MQTT broker
            function MQTTconnect(){
                console.log("connecting MQTT");
                mqtt = new Paho.MQTT.Client(host,port,"webpremiumfashion");

                var options = {
                    timeout: 3,
                    onSuccess: onConnect,
                    onFailure: onFailure,
                };

                mqtt.onMessageArrived = onMessageArrived;
                mqtt.connect(options);
            }
        </script>
    </head>
    <body>
        <!-- Navbar -->
          <nav class="navbar navbar-expand-md navbar-light p-1 primebackground shadow-sm p-3 mb-5 bg-body rounded">
            <div class="container-fluid">
                <a class="navbar-brand" href="./index.html" >
                    <div class="row">
                        <div class="col" style="text-align:center">
                            <img src="./assets/img/logo.png" alt="" width="auto" height="40" class="d-inline-block align-text-top">
                            <span>Premium Fashion - Verify Product</span>
                        </div>
                    </div>
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation" >
                <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end navbar-menu" id="navbarSupportedContent">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="./index.html" style="color:#a0a0a0"><Strong>Home</Strong></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./create-product.html" style="color:#a0a0a0"><Strong>Add Product (Demo)</Strong></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./verify.html" style="color:#a0a0a0"><Strong>Check Product</Strong></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="./register.html" style="color:#a0a0a0"><Strong>Register</Strong></a>
                        </li>

                    </ul>
                </div>
            </div>
        </nav>


        <!-- How to use -->
        <div class="container" style="">
            <div class="row" style="padding-bottom:50px">
                <div class="col">
                    <div class="card no-border">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6" style="text-align:center">
                                    <div class="row">
                                        <div class="row">
                                            <img src="https://i.pinimg.com/originals/62/98/b0/6298b026a65cf80bcf9dce061e9b79c9.png" style="height:200px; width:100%; object-fit:contain; text-align:center">
                                        </div>
                                        <div class="row" style="padding-top:20px">
                                            <h3><b>Hint: </b></h3>
                                            <br>
                                            <p>
                                                Input cloth data in the next column
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-6" id="blockchain_data">
                                    <div class="row align-items-center" style="height: 50vh;">
                                        <div class="mx-auto">
                                            <!-- Product Name -->
                                            <div class="mb-3">
                                                <label for="exampleFormControlInput1" class="form-label">Product Name</label>
                                                <input type="email" class="form-control" id="inputName" placeholder="Black T-Shirt">
                                            </div>
                                            <!-- Product ID -->
                                            <div class="mb-3">
                                                <label for="exampleFormControlInput1" class="form-label">Product ID</label>
                                                <input type="email" class="form-control" id="inputID" placeholder="PF-170845">
                                            </div>
                                            <!-- Product Description -->
                                            <div class="mb-3">
                                                <label for="exampleFormControlTextarea1" class="form-label">Product Description</label>
                                                <textarea class="form-control" id="inputDescription" rows="3"></textarea>
                                            </div>
                                            <!-- Submit -->
                                            <div class="row" style="text-align: right;">
                                                <div class="mb-3">
                                                    <button type="submit" class="btn btn-primary mb-3" onclick="create()">Create Product</button>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> 
        </div>


        <!-- JS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <!-- Keccak-256 -->
        <!-- MQTT -->

        <script>
        </script>
    </body>
</html>
